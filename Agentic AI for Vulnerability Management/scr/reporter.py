from typing import List
from models import ScanSummary, Vulnerability


class Reporter:
    def generate_report(self, summary: ScanSummary, top_risks: List[Vulnerability]) -> str:
        """
        Generate comprehensive vulnerability report with:
        - Scan type and scanner information
        - Host device names and both private/public IPs
        - CVSS v3 and MITRE ATT&CK mapping
        - Detailed remediation guidance
        """
        report = []
        
        # ===== 1. SCAN INFORMATION =====
        report.append("=" * 100)
        report.append("1. SCAN INFORMATION")
        report.append("=" * 100)
        report.append(f"Scan Type:       {summary.scan_type}")
        report.append(f"Scanner:         {summary.scanner_name}")
        if summary.scanner_version:
            report.append(f"Scanner Version: {summary.scanner_version}")
        if summary.scan_duration:
            report.append(f"Scan Duration:   {summary.scan_duration}")
        report.append("")

        # ===== 2. VULNERABILITY FINDINGS SUMMARY =====
        report.append("=" * 100)
        report.append("2. VULNERABILITY FINDINGS SUMMARY")
        report.append("=" * 100)
        report.append(f"Date: {summary.date}")
        report.append(f"Scanned Hosts: {', '.join(summary.scanned_hosts)}")
        report.append(f"Total Scans Analyzed: {summary.scans_analyzed}")
        report.append(f"Raw Vulnerabilities: {summary.raw_vulnerabilities}")
        report.append(f"Unique Vulnerabilities: {summary.unique_vulnerabilities}")
        report.append("Severity Breakdown:")
        for sev, count in summary.severity_breakdown.items():
            report.append(f"  - {sev}: {count}")
        report.append(f"Overall Risk Posture: {summary.overall_risk_posture}")
        
        report.append("\nData Enrichment Status:")
        report.append(f"  - Vulnerabilities with CVSS v3 Score: {summary.with_cvss} / {summary.unique_vulnerabilities}")
        report.append(f"  - Vulnerabilities with MITRE ATT&CK Mapping: {summary.with_mitre_mapping} / {summary.unique_vulnerabilities}")
        report.append(f"  - Vulnerabilities with Host Details: {summary.with_host_details} / {summary.unique_vulnerabilities}")
        report.append("")

        # ===== 3. TOP 10 RISK-PRIORITIZED VULNERABILITIES =====
        report.append("=" * 100)
        report.append("3. TOP 10 RISK-PRIORITIZED VULNERABILITIES")
        report.append("=" * 100)
        
        for i, v in enumerate(top_risks[:10], 1):
            report.append(f"\n{i}. [{v.priority}] {v.plugin_name}")
            report.append(f"   Plugin ID: {v.plugin_id}")
            report.append(f"   Risk Score: {v.risk_score:.1f}/10.0 | CVSS Base: {v.cvss_base_score:.1f}")
            
            # Display CVSS v3 metrics if available
            if v.cvss:
                report.append(f"   CVSS v3: {v.cvss.base_score:.1f} ({v.cvss.severity_rating})")
                report.append(f"   Vector: {v.cvss.vector_string}")
            
            report.append(f"   Reason: {v.risk_reason}")
            
            # ===== Display detailed host information =====
            if v.host_details:
                report.append(f"\n   Affected Systems ({len(v.host_details)}):")
                for host in v.host_details:
                    # Host name and primary IP
                    if host.hostname:
                        report.append(f"     • Device: {host.hostname}")
                    else:
                        report.append(f"     • Device: {host.ip_address}")
                    
                    # IP address information
                    report.append(f"       Primary IP: {host.ip_address}")
                    
                    if host.private_ip and host.private_ip != host.ip_address:
                        report.append(f"       Private IP: {host.private_ip}")
                    
                    if host.public_ip and host.public_ip != host.ip_address:
                        report.append(f"       Public IP: {host.public_ip}")
                    
                    # Port and protocol
                    if host.port and host.protocol:
                        report.append(f"       Service: {host.port}/{host.protocol}")
                    elif host.port:
                        report.append(f"       Port: {host.port}")
                    
                    # OS Information
                    if host.os_type:
                        os_info = f"{host.os_type}"
                        if host.os_version:
                            os_info += f" {host.os_version}"
                        report.append(f"       OS: {os_info}")
                    
                    # MAC Address
                    if host.mac_address:
                        report.append(f"       MAC: {host.mac_address}")
            else:
                report.append(f"\n   Affected Hosts: {len(v.hosts)}")
                for host_str in v.hosts[:3]:
                    report.append(f"     • {host_str}")
                if len(v.hosts) > 3:
                    report.append(f"     ... and {len(v.hosts) - 3} more")
            
            # Display MITRE ATT&CK techniques
            if v.attack_techniques:
                report.append(f"\n   MITRE ATT&CK Techniques ({len(v.attack_techniques)}):")
                tactics_dict = {}
                for technique in v.attack_techniques:
                    if technique.tactic not in tactics_dict:
                        tactics_dict[technique.tactic] = []
                    tactics_dict[technique.tactic].append(technique)
                
                for tactic in sorted(tactics_dict.keys()):
                    report.append(f"     [{tactic}]")
                    for technique in tactics_dict[tactic]:
                        report.append(f"       - {technique.technique_id}: {technique.technique_name}")
        
        report.append("")

        # ===== 4. EXECUTIVE SUMMARY =====
        report.append("=" * 100)
        report.append("4. EXECUTIVE SUMMARY")
        report.append("=" * 100)
        report.append(summary.executive_summary)
        report.append("")

        # ===== 5. REMEDIATION PLAN WITH HOST TARGETS =====
        report.append("=" * 100)
        report.append("5. REMEDIATION PLAN")
        report.append("=" * 100)
        
        report.append("PRIORITY 1 (0-7 Days) - IMMEDIATE ACTION REQUIRED:")
        p1_vulns = [v for v in top_risks if v.priority == "Priority 1"]
        if p1_vulns:
            for idx, v in enumerate(p1_vulns, 1):
                report.append(f"\n  {idx}. {v.plugin_name}")
                report.append(f"     Risk Score: {v.risk_score:.1f}/10.0 | CVSS: {v.cvss_base_score:.1f}")
                report.append(f"     Issue: {v.risk_reason}")
                report.append(f"     Solution: {v.solution}")
                report.append(f"     Action: {v.remediation_plan}")
                
                # Target hosts with details
                if v.host_details:
                    report.append(f"\n     Target Systems ({len(v.host_details)}):")
                    for host in v.host_details:
                        target = f"{host.hostname}" if host.hostname else f"{host.ip_address}"
                        report.append(f"       • {target}")
                        if host.private_ip and host.private_ip != host.ip_address:
                            report.append(f"         Private: {host.private_ip}")
                        if host.public_ip:
                            report.append(f"         Public: {host.public_ip}")
                        if host.port:
                            report.append(f"         Port: {host.port}")
                        if host.os_type:
                            report.append(f"         OS: {host.os_type}")
        else:
            report.append("  - None identified.")
            
        report.append("\n\nPRIORITY 2 (7-30 Days):")
        p2_vulns = [v for v in top_risks if v.priority == "Priority 2"]
        if p2_vulns:
            for idx, v in enumerate(p2_vulns, 1):
                report.append(f"\n  {idx}. {v.plugin_name}")
                report.append(f"     Risk Score: {v.risk_score:.1f}/10.0")
                report.append(f"     Solution: {v.solution}")
                
                # Target hosts
                if v.host_details:
                    report.append(f"     Target Systems ({len(v.host_details)}):")
                    for host in v.host_details[:5]:
                        target = f"{host.hostname}" if host.hostname else f"{host.ip_address}"
                        report.append(f"       • {target} ({host.ip_address})")
                    if len(v.host_details) > 5:
                        report.append(f"       ... and {len(v.host_details) - 5} more systems")
        else:
            report.append("  - None identified.")

        report.append("\n\nPRIORITY 3 (Ongoing):")
        p3_vulns = [v for v in top_risks if v.priority == "Priority 3"]
        if p3_vulns:
            for v in p3_vulns[:5]:
                report.append(f"\n  - {v.plugin_name}")
                report.append(f"    Risk Score: {v.risk_score:.1f}/10.0")
                if v.host_details:
                    report.append(f"    Affected Systems: {len(v.host_details)}")
        else:
            report.append("  - None identified.")
        report.append("")

        # ===== 6. MITRE ATT&CK TECHNIQUE SUMMARY =====
        report.append("=" * 100)
        report.append("6. MITRE ATT&CK TECHNIQUE SUMMARY")
        report.append("=" * 100)
        
        all_techniques = {}
        tactic_summary = {}
        
        for v in top_risks[:20]:
            for technique in v.attack_techniques:
                if technique.technique_id not in all_techniques:
                    all_techniques[technique.technique_id] = technique
                
                if technique.tactic not in tactic_summary:
                    tactic_summary[technique.tactic] = 0
                tactic_summary[technique.tactic] += 1
        
        if all_techniques:
            report.append("Most Common MITRE ATT&CK Tactics:")
            for tactic in sorted(tactic_summary.keys()):
                report.append(f"  - {tactic}: {tactic_summary[tactic]} vulnerabilities")
            
            report.append("\nDetection & Response Focus Areas:")
            report.append("  Use these MITRE ATT&CK techniques as indicators for detection rules:")
            for technique_id in sorted(all_techniques.keys())[:10]:
                technique = all_techniques[technique_id]
                report.append(f"  - {technique.technique_id}: {technique.technique_name}")
        else:
            report.append("No MITRE ATT&CK techniques mapped for current vulnerabilities.")
        
        report.append("")

        # ===== 7. COMMUNICATION PLAN =====
        report.append("=" * 100)
        report.append("7. COMMUNICATION PLAN")
        report.append("=" * 100)
        report.append("  Executives: Share 'Executive Summary' and 'Overall Risk Posture'.")
        report.append("  IT Operations: Distribute 'Remediation Plan' with host details and target systems.")
        report.append("  Network Team: Use host IP information (private/public) for network segmentation.")
        report.append("  Security Team: Monitor 'Top 10' vulnerabilities and create detection rules from MITRE techniques.")
        report.append("  System Owners: Review affected systems and prioritize patching by device name and OS type.")
        report.append("")

        # ===== 8. SUCCESS METRICS & CADENCE =====
        report.append("=" * 100)
        report.append("8. SUCCESS METRICS & CADENCE")
        report.append("=" * 100)
        report.append(f"  Scan Type: {summary.scan_type}")
        report.append(f"  Scanner: {summary.scanner_name}")
        if summary.scanner_version:
            report.append(f"  Scanner Version: {summary.scanner_version}")
        report.append("  - Mean Time to Remediate (MTTR) for Priority 1: < 7 days")
        report.append("  - Reduction in Critical/High vulnerabilities: 10% month-over-month")
        report.append("  - Reporting Cadence: Weekly after every scan cycle")
        report.append("  - Enrichment Goal: 100% CVSS v3 + MITRE ATT&CK mapping + Host detail coverage")
        
        return "\n".join(report)
