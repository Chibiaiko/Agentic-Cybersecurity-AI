from typing import List
from models import ScanSummary, Vulnerability



class Reporter:
    def generate_report(self, summary: ScanSummary, top_risks: List[Vulnerability]) -> str:
        """
        Generate comprehensive vulnerability report with:
        - Scan type and scanner information
        - Host device names and both private/public IPs
        - CVSS v3 and MITRE ATT&CK mapping
        - Detailed remediation guidance
        - Executive summary
        - Final workflow summary
        """
        report = []

    

        # ===== 1. SCAN INFORMATION =====
        report.append("=" * 100)
        report.append("1. SCAN INFORMATION")
        report.append("=" * 100)
        report.append(f"Scan Type:       {summary.scan_type}")
        report.append(f"Scanner:         {summary.scanner_name}")
        if summary.scanner_version:
            report.append(f"Scanner Version: {summary.scanner_version}")
        if summary.scan_duration:
            report.append(f"Scan Duration:   {summary.scan_duration}")
        report.append("")

        # ===== 2. VULNERABILITY FINDINGS SUMMARY =====
        report.append("=" * 100)
        report.append("2. VULNERABILITY FINDINGS SUMMARY")
        report.append("=" * 100)
        report.append(f"Date: {summary.date}")
        report.append(f"Scanned Hosts: {', '.join(summary.scanned_hosts)}")
        report.append(f"Total Scans Analyzed: {summary.scans_analyzed}")
        report.append(f"Raw Vulnerabilities: {summary.raw_vulnerabilities}")
        report.append(f"Unique Vulnerabilities: {summary.unique_vulnerabilities}")
        report.append("Severity Breakdown:")
        for sev, count in summary.severity_breakdown.items():
            report.append(f"  - {sev}: {count}")
        report.append(f"Overall Risk Posture: {summary.overall_risk_posture}")

        report.append("\nData Enrichment Status:")
        report.append(f"  - Vulnerabilities with CVSS v3 Score: {summary.with_cvss} / {summary.unique_vulnerabilities}")
        report.append(f"  - Vulnerabilities with MITRE ATT&CK Mapping: {summary.with_mitre_mapping} / {summary.unique_vulnerabilities}")
        report.append(f"  - Vulnerabilities with Host Details: {summary.with_host_details} / {summary.unique_vulnerabilities}")
        report.append("")

        # ===== 3. TOP 10 RISK-PRIORITIZED VULNERABILITIES =====
        report.append("=" * 100)
        report.append("3. TOP 10 RISK-PRIORITIZED VULNERABILITIES")
        report.append("=" * 100)

        for i, v in enumerate(top_risks[:10], 1):
            report.append(f"\n{i}. [{v.priority}] {v.plugin_name}")
            report.append(f"   Plugin ID: {v.plugin_id}")
            report.append(f"   Risk Score: {v.risk_score:.1f}/10.0 | CVSS Base: {v.cvss_base_score:.1f}")

            if v.cvss:
                report.append(f"   CVSS v3: {v.cvss.base_score:.1f} ({v.cvss.severity_rating})")
                report.append(f"   Vector: {v.cvss.vector_string}")

            report.append(f"   Reason: {v.risk_reason}")

            if v.host_details:
                report.append(f"\n   Affected Systems ({len(v.host_details)}):")
                for host in v.host_details:
                    target = host.hostname if host.hostname else host.ip_address
                    report.append(f"     • Device: {target}")
                    report.append(f"       Primary IP: {host.ip_address}")
                    if host.private_ip and host.private_ip != host.ip_address:
                        report.append(f"       Private IP: {host.private_ip}")
                    if host.public_ip and host.public_ip != host.ip_address:
                        report.append(f"       Public IP: {host.public_ip}")
                    if host.port:
                        report.append(f"       Port: {host.port}")
                    if host.os_type:
                        os_info = f"{host.os_type} {host.os_version}" if host.os_version else host.os_type
                        report.append(f"       OS: {os_info}")
                    if host.mac_address:
                        report.append(f"       MAC: {host.mac_address}")
            else:
                report.append(f"\n   Affected Hosts: {len(v.hosts)}")
                for host_str in v.hosts[:3]:
                    report.append(f"     • {host_str}")
                if len(v.hosts) > 3:
                    report.append(f"     ... and {len(v.hosts) - 3} more")

            if v.attack_techniques:
                report.append(f"\n   MITRE ATT&CK Techniques ({len(v.attack_techniques)}):")
                tactics_dict = {}
                for technique in v.attack_techniques:
                    if technique.tactic not in tactics_dict:
                        tactics_dict[technique.tactic] = []
                    tactics_dict[technique.tactic].append(technique)
                for tactic in sorted(tactics_dict.keys()):
                    report.append(f"     [{tactic}]")
                    for technique in tactics_dict[tactic]:
                        report.append(f"       - {technique.technique_id}: {technique.technique_name}")

        report.append("")

        # ===== 4. EXECUTIVE SUMMARY =====
        report.append("=" * 100)
        report.append("4. EXECUTIVE SUMMARY")
        report.append("=" * 100)
        report.append(summary.executive_summary)
        report.append("")

        # ===== 5-7. REMEDIATION PLAN, MITRE, COMM PLAN =====
        # ... keep your existing code unchanged for sections 5, 6, 7 ...
        # For brevity, I’m not repeating all lines here

        # ===== 8. SUCCESS METRICS & CADENCE =====
        report.append("=" * 100)
        report.append("8. SUCCESS METRICS & CADENCE")
        report.append("=" * 100)
        report.append(f"  Scan Type: {summary.scan_type}")
        report.append(f"  Scanner: {summary.scanner_name}")
        if summary.scanner_version:
            report.append(f"  Scanner Version: {summary.scanner_version}")
        report.append("  - Mean Time to Remediate (MTTR) for Priority 1: < 7 days")
        report.append("  - Reduction in Critical/High vulnerabilities: 10% month-over-month")
        report.append("  - Reporting Cadence: Weekly after every scan cycle")
        report.append("  - Enrichment Goal: 100% CVSS v3 + MITRE ATT&CK mapping + Host detail coverage")

        # ===== 9. FINAL SUMMARY (End-to-End Workflow) =====
        report.append("\n" + "=" * 100)
        report.append("9. FINAL SUMMARY")
        report.append("=" * 100)
        report.append("End-to-end Vulnerability Management Workflow:")
        report.append("  - Detection: Scan results collected and analyzed")
        report.append("  - Prioritization: Risk-based categorization applied (Priority 1–3)")
        report.append("  - Remediation planning: Owner assignments, timelines, and validation steps")
        report.append("  - Communication & governance: Ensuring visibility across teams")
        report.append("")

        return "\n".join(report)
