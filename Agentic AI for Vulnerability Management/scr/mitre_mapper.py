"""
mitre_mapper.py - Lightweight MITRE ATT&CK technique mapper.

This stateless module maps CVE/plugin IDs and vulnerability metadata to MITRE ATT&CK techniques.
It maintains a curated knowledge base of common vulnerability patterns and their corresponding ATT&CK techniques.

Imports MitreAttackTechnique from models.py (which is the correct architecture).
"""

from typing import List, Dict
from models import MitreAttackTechnique


class MitreMapper:
    """
    Stateless mapper from vulnerability metadata to MITRE ATT&CK techniques.
    
    Uses pattern matching on vulnerability names and descriptions to identify
    relevant MITRE ATT&CK techniques.
    """
    
    # ===== CURATED VULNERABILITY PATTERN â†’ ATT&CK MAPPING DATABASE =====
    # In production, this could be loaded from a database or API.
    # For this POC, we maintain a curated mapping.
    
    VULNERABILITY_PATTERNS = {
        # Remote Code Execution (RCE) patterns
        "rce": [
            MitreAttackTechnique("T1047", "Windows Management Instrumentation", "Execution"),
            MitreAttackTechnique("T1059.001", "PowerShell", "Execution"),
        ],
        "remote code execution": [
            MitreAttackTechnique("T1059", "Command and Scripting Interpreter", "Execution"),
        ],
        "arbitrary code execution": [
            MitreAttackTechnique("T1059", "Command and Scripting Interpreter", "Execution"),
        ],
        
        # Privilege Escalation patterns
        "privilege escalation": [
            MitreAttackTechnique("T1548", "Abuse Elevation Control Mechanism", "Privilege Escalation"),
            MitreAttackTechnique("T1134", "Access Token Manipulation", "Privilege Escalation"),
        ],
        "elevation of privilege": [
            MitreAttackTechnique("T1548.002", "Bypass User Account Control", "Privilege Escalation"),
            MitreAttackTechnique("T1548.004", "Elevated Execution with Prompt", "Privilege Escalation"),
        ],
        "local privilege escalation": [
            MitreAttackTechnique("T1548", "Abuse Elevation Control Mechanism", "Privilege Escalation"),
        ],
        
        # Information Disclosure / Data Exfiltration
        "information disclosure": [
            MitreAttackTechnique("T1005", "Data from Local System", "Collection"),
            MitreAttackTechnique("T1087", "Account Discovery", "Discovery"),
        ],
        "directory traversal": [
            MitreAttackTechnique("T1083", "File and Directory Discovery", "Discovery"),
        ],
        "path traversal": [
            MitreAttackTechnique("T1083", "File and Directory Discovery", "Discovery"),
        ],
        
        # SQL Injection
        "sql injection": [
            MitreAttackTechnique("T1005", "Data from Local System", "Collection"),
            MitreAttackTechnique("T1213.001", "Data from Information Repositories", "Collection"),
        ],
        
        # Authentication Bypass
        "authentication bypass": [
            MitreAttackTechnique("T1110", "Brute Force", "Credential Access"),
            MitreAttackTechnique("T1556", "Modify Authentication Process", "Defense Evasion"),
        ],
        "default credentials": [
            MitreAttackTechnique("T1078", "Valid Accounts", "Defense Evasion"),
            MitreAttackTechnique("T1110.001", "Password Guessing", "Credential Access"),
        ],
        
        # Denial of Service
        "denial of service": [
            MitreAttackTechnique("T1499", "Endpoint Denial of Service", "Impact"),
        ],
        "dos": [
            MitreAttackTechnique("T1499.001", "HTTP Flood", "Impact"),
        ],
        
        # SSL/TLS Weaknesses
        "ssl": [
            MitreAttackTechnique("T1557.001", "LLMNR/NBT-NS Poisoning and SMB Relay", "Credential Access"),
            MitreAttackTechnique("T1040", "Network Sniffing", "Discovery"),
        ],
        "tls": [
            MitreAttackTechnique("T1040", "Network Sniffing", "Discovery"),
        ],
        "weak encryption": [
            MitreAttackTechnique("T1041", "Exfiltration Over C2 Channel", "Exfiltration"),
        ],
        
        # Buffer Overflow / Memory Corruption
        "buffer overflow": [
            MitreAttackTechnique("T1190", "Exploit Public-Facing Application", "Initial Access"),
        ],
        "memory corruption": [
            MitreAttackTechnique("T1190", "Exploit Public-Facing Application", "Initial Access"),
        ],
        
        # XXE (XML External Entity)
        "xxe": [
            MitreAttackTechnique("T1005", "Data from Local System", "Collection"),
            MitreAttackTechnique("T1083", "File and Directory Discovery", "Discovery"),
        ],
        "xml external entity": [
            MitreAttackTechnique("T1005", "Data from Local System", "Collection"),
        ],
        
        # CSRF / XSS
        "cross-site scripting": [
            MitreAttackTechnique("T1566.002", "Phishing: Spearphishing Link", "Initial Access"),
            MitreAttackTechnique("T1204.001", "User Execution: Malicious Link", "Execution"),
        ],
        "xss": [
            MitreAttackTechnique("T1204", "User Execution", "Execution"),
        ],
        
        # LDAP Injection
        "ldap injection": [
            MitreAttackTechnique("T1087", "Account Discovery", "Discovery"),
            MitreAttackTechnique("T1087.002", "Domain Account", "Discovery"),
        ],
        
        # Command Injection
        "command injection": [
            MitreAttackTechnique("T1059", "Command and Scripting Interpreter", "Execution"),
            MitreAttackTechnique("T1190", "Exploit Public-Facing Application", "Initial Access"),
        ],
        
        # Apache Struts (CVE-2017-5645, etc.)
        "struts": [
            MitreAttackTechnique("T1190", "Exploit Public-Facing Application", "Initial Access"),
            MitreAttackTechnique("T1059", "Command and Scripting Interpreter", "Execution"),
        ],
        
        # Windows Print Spooler (PrintNightmare)
        "print spooler": [
            MitreAttackTechnique("T1548.004", "Elevated Execution with Prompt", "Privilege Escalation"),
            MitreAttackTechnique("T1190", "Exploit Public-Facing Application", "Initial Access"),
        ],
    }
    
    @classmethod
    def map_techniques(
        cls,
        plugin_id: str,
        plugin_name: str,
        description: str,
    ) -> List[MitreAttackTechnique]:
        """
        Map vulnerability metadata to MITRE ATT&CK techniques.
        
        Args:
            plugin_id: Vulnerability/plugin ID (e.g., CVE ID)
            plugin_name: Vulnerability title
            description: Technical description
        
        Returns:
            List of mapped MITRE ATT&CK techniques (deduplicated, sorted by tactic+id)
        """
        # Combine all text for pattern matching
        combined_text = f"{plugin_name} {description}".lower()
        
        # Track unique techniques to avoid duplicates
        # Using a set because MitreAttackTechnique is now frozen (hashable)
        techniques_set = set()
        
        # Pattern matching: iterate through vulnerability patterns
        for pattern, technique_list in cls.VULNERABILITY_PATTERNS.items():
            if pattern in combined_text:
                for technique in technique_list:
                    # Can add directly to set since MitreAttackTechnique is frozen
                    techniques_set.add(technique)
        
        # Convert back to list, sorted by tactic then ID
        techniques = sorted(techniques_set, key=lambda x: (x.tactic, x.technique_id))
        
        return techniques
    
    @classmethod
    def enrich_from_cve(
        cls,
        plugin_id: str,
        plugin_name: str,
    ) -> List[MitreAttackTechnique]:
        """
        Convenience method for mapping vulnerability by ID and name only.
        
        Args:
            plugin_id: Vulnerability/plugin ID
            plugin_name: Vulnerability title
        
        Returns:
            List of mapped MITRE ATT&CK techniques
        """
        return cls.map_techniques(plugin_id, plugin_name, "")
