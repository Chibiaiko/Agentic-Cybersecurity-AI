import json
import os
from datetime import datetime
from analyzer import Analyzer
from reporter import Reporter
from storage import Storage
from models import ScanSummary

def main():
    # Paths
    base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
    data_dir = os.path.join(base_dir, "data")
    output_dir = os.path.join(base_dir, "output")
    
    scan_file = os.path.join(data_dir, "sample_scan.json")
    threat_intel_file = os.path.join(data_dir, "threat_intel.json")
    report_file = os.path.join(output_dir, "report.txt")
    json_history_file = os.path.join(output_dir, "scan_summaries.json")

    print(f"Loading data from {base_dir}...")

    # Load Data
    with open(scan_file, 'r') as f:
        raw_scans = json.load(f)
    
    with open(threat_intel_file, 'r') as f:
        threat_intel = json.load(f)

    # Analyze
    analyzer = Analyzer(threat_intel)
    
    # ===== NEW: Set scan information =====
    # You can customize these values based on your actual scan
    analyzer.set_scan_info(
        scan_type="Network Vulnerability Scan",  # Type of scan
        scanner_name="Tenable Nessus",           # Scanner name
        scan_duration="2 hours 45 minutes",      # How long the scan took
        scanner_version="8.13.0"                 # Scanner version
    )
    
    # 1. Deduplicate (now with CVSS and MITRE ATT&CK and host details)
    unique_vulns = analyzer.deduplicate_scans(raw_scans)
    
    # 2. Prioritize (threat-intel-first, CVSS as supporting signal)
    prioritized_vulns = analyzer.prioritize_vulnerabilities(unique_vulns)
    
    # Calculate Stats
    severity_breakdown = {"Critical": 0, "High": 0, "Medium": 0, "Low": 0, "Info": 0}
    for v in unique_vulns:
        sev = v.severity
        if sev in severity_breakdown:
            severity_breakdown[sev] += 1
        else:
            severity_breakdown[sev] = severity_breakdown.get(sev, 0) + 1

    p1_count = len([v for v in prioritized_vulns if v.priority == "Priority 1"])
    p2_count = len([v for v in prioritized_vulns if v.priority == "Priority 2"])
    p3_count = len([v for v in prioritized_vulns if v.priority == "Priority 3"])

    # Collect all unique IPs
    all_ips = set()
    for v in unique_vulns:
        for loc in v.hosts:
            ip = loc.split(" ")[0]
            all_ips.add(ip)

    # ===== NEW: Count enrichment metrics =====
    cvss_count = len([v for v in unique_vulns if v.cvss is not None])
    mitre_count = len([v for v in unique_vulns if len(v.attack_techniques) > 0])
    host_detail_count = len([v for v in unique_vulns if len(v.host_details) > 0])

    # Determine Overall Posture
    if p1_count > 0:
        posture = "High - Immediate Action Required"
    elif p2_count > 5:
        posture = "Elevated"
    else:
        posture = "Moderate"

    # Executive Summary Generation (now with enrichment context)
    exec_summary = (
        f"Scan analysis detected {len(unique_vulns)} unique vulnerabilities across {len(all_ips)} hosts. "
        f"{p1_count} issues are critically prioritized due to active threats (RCE/Exploits). "
        f"Enrichment status: {cvss_count} vulnerabilities have CVSS v3 scores, "
        f"{mitre_count} are mapped to MITRE ATT&CK techniques, "
        f"and {host_detail_count} have detailed host information including device names and IP addresses. "
        "Immediate attention is required for web server and print spooler infrastructure."
    )
    
    rec_actions = (
        "1. Patch Apache Struts and PrintNightmare immediately. "
        "2. Review SSL configurations. "
        "3. Use host device names and IP information for targeted remediation. "
        "4. Use MITRE ATT&CK mappings to update detection rules and threat hunting queries."
    )

    # Create Summary Object
    today = datetime.now().strftime("%Y-%m-%d")
    summary = ScanSummary(
        date=today,
        scans_analyzed=1,
        scanned_hosts=sorted(list(all_ips)),
        raw_vulnerabilities=len(raw_scans),
        unique_vulnerabilities=len(unique_vulns),
        severity_breakdown=severity_breakdown,
        top_risks=[v.to_dict() for v in prioritized_vulns[:10]],
        priority_summary={
            "priority_1_0_7_days": p1_count,
            "priority_2_7_30_days": p2_count,
            "priority_3_ongoing": p3_count
        },
        overall_risk_posture=posture,
        executive_summary=exec_summary,
        recommended_next_actions=rec_actions,
        # ===== NEW: Enrichment metrics =====
        with_cvss=cvss_count,
        with_mitre_mapping=mitre_count,
        with_host_details=host_detail_count,
        # ===== NEW: Scan information =====
        scan_type="Network Vulnerability Scan",
        scan_duration="2 hours 45 minutes",
        scanner_name="Tenable Nessus",
        scanner_version="8.13.0",
    )

    # Generate Outputs
    reporter = Reporter()
    report_text = reporter.generate_report(summary, prioritized_vulns)
    
    # 1. Print Detailed Vulnerability List (Terminal View)
    print("\n")
    print("=" * 120)
    print(f" DETAILED VULNERABILITY LIST ({len(unique_vulns)} Unique Findings)")
    print("=" * 120)
    print(f"{'ID':<8} | {'SEVERITY':<10} | {'PRIORITY':<12} | {'RISK':<6} | {'CVSS':<6} | {'HOSTS':<6} | {'NAME'}")
    print("-" * 120)
    
    for v in prioritized_vulns:
        cvss_display = f"{v.cvss_base_score:.1f}" if v.cvss_base_score > 0 else "—"
        if v.cvss:
            cvss_display = f"{v.cvss.base_score:.1f}v3"
        
        host_count = len(v.host_details) if v.host_details else len(v.hosts)
        host_info = f"({len(v.host_details)} detailed)" if v.host_details else f"({len(v.hosts)} simple)"
        
        print(f"{v.plugin_id:<8} | {v.severity:<10} | {v.priority:<12} | {v.risk_score:<6.1f} | {cvss_display:<6} | {host_count:<6} | {v.plugin_name}")
        
        # Show host details in terminal
        if v.host_details:
            for host in v.host_details[:2]:
                host_str = f"    → {host.hostname}" if host.hostname else f"    → {host.ip_address}"
                if host.private_ip and host.private_ip != host.ip_address:
                    host_str += f" | Private: {host.private_ip}"
                if host.public_ip:
                    host_str += f" | Public: {host.public_ip}"
                print(host_str)
            if len(v.host_details) > 2:
                print(f"    → ... and {len(v.host_details) - 2} more")
        else:
            print(f"    → Hosts: {', '.join(v.hosts[:3])}")
    
    print("-" * 120)
    print("")

    # 2. Print Full Readable Text Report
    print("=" * 120)
    print(" FULL VULNERABILITY REPORT (WITH CVSS v3, MITRE ATT&CK, AND HOST DETAILS)")
    print("=" * 120)
    print(report_text)
    print("=" * 120)
    print("")

    # 3. Store in cumulative history
    storage = Storage(json_history_file)
    storage.update_cumulative_json(today, summary.to_dict())

    # 4. Write report to file
    with open(report_file, 'w') as f:
        f.write(report_text)

    print("Analysis complete.")
    print(f"Report written to: {report_file}")
    print(f"History updated: {json_history_file}")
    print(f"\nEnrichment Summary:")
    print(f"  - CVSS v3 Scores: {cvss_count}/{len(unique_vulns)} ({100*cvss_count/len(unique_vulns):.1f}%)")
    print(f"  - MITRE ATT&CK Mappings: {mitre_count}/{len(unique_vulns)} ({100*mitre_count/len(unique_vulns):.1f}%)")
    print(f"  - Host Details: {host_detail_count}/{len(unique_vulns)} ({100*host_detail_count/len(unique_vulns):.1f}%)")
    print(f"\nScan Information:")
    print(f"  - Scan Type: {summary.scan_type}")
    print(f"  - Scanner: {summary.scanner_name}")
    print(f"  - Duration: {summary.scan_duration}")
    print(f"  - Version: {summary.scanner_version}")

if __name__ == "__main__":
    main()
