import json
import os
from datetime import datetime
from analyzer import Analyzer
from reporter import Reporter
from storage import Storage
from models import ScanSummary, SEVERITY_COLORS

def main():
    # ===== Paths =====
    base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
    data_dir = os.path.join(base_dir, "data")
    output_dir = os.path.join(base_dir, "output")
    scan_file = os.path.join(data_dir, "sample_scan.json")
    threat_intel_file = os.path.join(data_dir, "threat_intel.json")
    report_file_txt = os.path.join(output_dir, "report.txt")
    report_file_json = os.path.join(output_dir, "report.json")
    json_history_file = os.path.join(output_dir, "scan_summaries.json")

    print(f"Loading scan data from {base_dir}...")

    # ===== Load Data =====
    with open(scan_file, "r", encoding="utf-8") as f:
        raw_scans = json.load(f)
    with open(threat_intel_file, "r", encoding="utf-8") as f:
        threat_intel = json.load(f)

    # ===== Analyzer =====
    analyzer = Analyzer(threat_intel)
    analyzer.set_scan_info(
        scan_type="Network Vulnerability Scan",
        scanner_name="Tenable Nessus",
        scan_duration="2 hours 45 minutes",
        scanner_version="8.13.0"
    )

    # ===== Deduplicate and Prioritize =====
    unique_vulns = analyzer.deduplicate_scans(raw_scans)
    prioritized_vulns = analyzer.prioritize_vulnerabilities(unique_vulns)

    # ===== Severity Counts =====
    severity_breakdown = {sev: 0 for sev in SEVERITY_COLORS.keys()}
    for v in unique_vulns:
        severity_breakdown[v.severity] = severity_breakdown.get(v.severity, 0) + 1

    # ===== Priority Counts =====
    p1_count = len([v for v in prioritized_vulns if v.priority == "Priority 1"])
    p2_count = len([v for v in prioritized_vulns if v.priority == "Priority 2"])
    p3_count = len([v for v in prioritized_vulns if v.priority == "Priority 3"])

    # ===== Unique Hosts =====
    all_ips = set()
    for v in unique_vulns:
        for loc in v.hosts:
            ip = loc.split(" ")[0]
            all_ips.add(ip)

    # ===== Enrichment Metrics =====
    cvss_count = len([v for v in unique_vulns if v.cvss is not None])
    mitre_count = len([v for v in unique_vulns if len(v.attack_techniques) > 0])
    host_detail_count = len([v for v in unique_vulns if len(v.host_details) > 0])

    # ===== Overall Posture =====
    if p1_count > 0:
        posture = "High - Immediate Action Required"
    elif p2_count > 5:
        posture = "Elevated"
    else:
        posture = "Moderate"

    # ===== Remediation Plan =====
    remediation_plan = (
        "Priority 1 (0–7 days): Immediate fixes such as Defender updates, "
        "WinVerifyTrust mitigation, Outlook patches, Teams upgrade.\n"
        "Priority 2 (7–30 days): TLS/SSL hardening and certificate hygiene.\n"
        "Priority 3 (Ongoing): Continuous monitoring and deprecation tracking for legacy protocols."
    )

    # ===== Executive Summary (simple) =====
    exec_summary = (
        f"Total vulnerabilities discovered: {len(unique_vulns)}\n"
        f"Top 10 risk-prioritized issues:\n" +
        "".join(
            f"{i}. {v.plugin_name} | Severity: {v.severity} | Priority: {v.priority} | Hosts: {len(v.hosts)}\n"
            for i, v in enumerate(prioritized_vulns[:10], 1)
        ) +
        f"\nRisk categorization:\n"
        f"- Immediate (Priority 1): {p1_count}\n"
        f"- Medium (Priority 2): {p2_count}\n"
        f"- Low/Ongoing (Priority 3): {p3_count}\n"
    )

    # ===== Create ScanSummary Object =====
    today = datetime.now().strftime("%Y-%m-%d")
    summary = ScanSummary(
        date=today,
        scans_analyzed=1,
        scanned_hosts=sorted(all_ips),
        raw_vulnerabilities=len(raw_scans),
        unique_vulnerabilities=len(unique_vulns),
        severity_breakdown=severity_breakdown,
        top_risks=[v.to_dict() for v in prioritized_vulns[:10]],
        priority_summary={
            "priority_1_0_7_days": p1_count,
            "priority_2_7_30_days": p2_count,
            "priority_3_ongoing": p3_count
        },
        overall_risk_posture=posture,
        executive_summary=exec_summary,
        recommended_next_actions=remediation_plan,
        with_cvss=cvss_count,
        with_mitre_mapping=mitre_count,
        with_host_details=host_detail_count,
        scan_type=analyzer.scan_type,
        scan_duration=analyzer.scan_duration,
        scanner_name=analyzer.scanner_name,
        scanner_version=analyzer.scanner_version
    )

    # ===== Generate Full Report =====
    reporter = Reporter()
    full_report = reporter.generate_report(summary, prioritized_vulns)

    # ===== Terminal Display: Scan Summary =====
    RED = "\033[91m"
    ORANGE = "\033[33m"
    GREEN = "\033[32m"
    LIGHT_BLUE = "\033[94m"
    RESET = "\033[0m"

    print("\n" + "="*120)
    print("SCAN SUMMARY")
    print("="*120)
    print(f"Scan Date: {summary.date}")
    print(f"Scan Type: {summary.scan_type}")
    print(f"Scanner: {summary.scanner_name} {summary.scanner_version}")
    print(f"Scan Duration: {summary.scan_duration}")
    print(f"Total Hosts Scanned: {len(all_ips)}")
    print(f"Total Scans Analyzed: {summary.scans_analyzed}")
    print(f"Raw Vulnerabilities: {summary.raw_vulnerabilities}")
    print(f"Unique Vulnerabilities: {summary.unique_vulnerabilities}")
    print(f"Severity Breakdown:")
    for sev, count in summary.severity_breakdown.items():
        print(f"  - {sev}: {count}")
    print(f"Overall Risk Posture: {summary.overall_risk_posture}")
    print(f"Data Enrichment Metrics:")
    print(f"  - With CVSS: {summary.with_cvss}")
    print(f"  - With MITRE Mapping: {summary.with_mitre_mapping}")
    print(f"  - With Host Details: {summary.with_host_details}")
    print("="*120 + "\n")

    # ===== Terminal Display: Detailed Vulnerabilities =====
    print(f"{'ID':<8} | {'SEVERITY':<10} | {'PRIORITY':<12} | {'RISK':<6} | {'CVSS':<6} | {'HOSTS':<6} | {'NAME'}")
    print("-"*120)
    for v in prioritized_vulns:
        color = SEVERITY_COLORS.get(v.severity, "")
        reset = "\033[0m"
        cvss_display = f"{v.cvss.base_score:.1f}v3" if v.cvss else "—"
        host_count = len(v.host_details) if v.host_details else len(v.hosts)
        print(f"{v.plugin_id:<8} | {color}{v.severity:<10}{reset} | {v.priority:<12} | {v.risk_score:<6.1f} | {cvss_display:<6} | {host_count:<6} | {v.plugin_name}")

        # Show host details (up to 3)
        if v.host_details:
            for host in v.host_details[:3]:
                host_str = f"     → {host.hostname or host.ip_address}"
                if getattr(host, "private_ip", None) and host.private_ip != host.ip_address:
                    host_str += f" | Private: {host.private_ip}"
                if getattr(host, "public_ip", None):
                    host_str += f" | Public: {host.public_ip}"
                print(host_str)
            if len(v.host_details) > 3:
                print(f"     → ... and {len(v.host_details) - 3} more hosts")
        else:
            print(f"     → Hosts: {', '.join(v.hosts[:3])}")
    print("-"*120 + "\n")

    # ===== Terminal Display: FINAL SUMMARY Workflow =====
    workflow_summary = (
        f"{RED}  - Detection:{RESET} Scan results collected and analyzed\n"
        f"{ORANGE}  - Prioritization:{RESET} Risk-based categorization applied (Priority 1–3)\n"
        f"{GREEN}  - Remediation Planning:{RESET} Owner assignments, timelines, and validation steps\n"
        f"{LIGHT_BLUE}  - Communication & Governance:{RESET} Ensuring visibility across teams\n"
    )
    print("="*120)
    print("FINAL WORKFLOW SUMMARY")
    print("="*120)
    print(workflow_summary)
    print("="*120 + "\n")

    # ===== Save TXT & JSON =====
    full_report += workflow_summary  # append workflow to full report
    with open(report_file_txt, "w", encoding="utf-8") as f:
        f.write(full_report)
    with open(report_file_json, "w", encoding="utf-8") as f:
        json.dump(summary.to_dict(), f, indent=2, ensure_ascii=False)

    # ===== Update cumulative history =====
    storage = Storage(json_history_file)
    storage.update_cumulative_json(summary.date, summary.to_dict())

    print("\nReports written:")
    print(f" - TXT: {report_file_txt}")
    print(f" - JSON: {report_file_json}")
    print("Analysis complete.")

if __name__ == "__main__":
    main()
